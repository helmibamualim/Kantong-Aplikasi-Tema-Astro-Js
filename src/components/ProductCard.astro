---
interface Props {
  id: string;
  name: string;
  price: number;
  originalPrice?: number;
  image: string;
  rating: number;
  reviews: number;
  badge?: string;
  inStock: boolean;
}

const { id, name, price, originalPrice, image, rating, reviews, badge, inStock } = Astro.props;
const discount = originalPrice ? Math.round(((originalPrice - price) / originalPrice) * 100) : 0;
const estimatedDelivery = 'Est. delivery: 2-3 days';
---

<div class={`group relative bg-white dark:bg-dark-800 rounded-2xl overflow-hidden border border-gray-200 dark:border-dark-700 hover:border-primary-500 dark:hover:border-primary-500 transition-all duration-500 hover:shadow-2xl hover:scale-[1.03] animate-on-scroll ${!inStock ? 'opacity-60' : ''}`}>
  <!-- Modern Pill Badges with Glow - Mobile Optimized -->
  {badge && (
    <div class="absolute top-2 sm:top-3 left-2 sm:left-3 z-30 px-2 sm:px-4 py-1 sm:py-2 bg-gradient-to-r from-primary-600 to-primary-700 text-white text-[10px] sm:text-xs font-bold rounded-full shadow-[0_0_20px_rgba(251,146,60,0.5)] backdrop-blur-sm border border-primary-400/30">
      <span class="relative z-10 flex items-center gap-1 sm:gap-1.5">
        <span class="w-1 sm:w-1.5 h-1 sm:h-1.5 bg-white rounded-full animate-pulse"></span>
        {badge}
      </span>
    </div>
  )}
  
  {discount > 0 && (
    <div class="absolute top-2 sm:top-3 right-2 sm:right-3 z-30 px-2 sm:px-4 py-1 sm:py-2 bg-gradient-to-r from-red-600 to-red-700 text-white text-[10px] sm:text-xs font-bold rounded-full shadow-[0_0_20px_rgba(220,38,38,0.6)] backdrop-blur-sm border border-red-400/30">
      <span class="relative z-10 flex items-center gap-0.5 sm:gap-1">
        <svg class="w-2.5 h-2.5 sm:w-3 sm:h-3" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd" />
        </svg>
        -{discount}%
      </span>
      <span class="absolute inset-0 bg-white/20 rounded-full blur-sm animate-pulse"></span>
    </div>
  )}

  {!inStock && (
    <div class="absolute top-2 sm:top-3 left-2 sm:left-3 z-30 px-2 sm:px-4 py-1 sm:py-2 bg-gray-600/90 dark:bg-gray-700/90 backdrop-blur-sm text-white text-[10px] sm:text-xs font-bold rounded-full shadow-lg border border-gray-500/30">
      Out of Stock
    </div>
  )}

  <!-- Enhanced Quick Actions with Tooltips - Hidden on Mobile, Show on Hover Desktop -->
  <div class="absolute top-2 sm:top-3 right-2 sm:right-3 z-30 hidden sm:flex flex-col gap-2.5 opacity-0 group-hover:opacity-100 transform translate-x-6 group-hover:translate-x-0 transition-all duration-300 delay-75">
    <div class="relative group/tooltip">
      <button
        data-quick-view={id}
        class="w-11 h-11 bg-white/95 dark:bg-dark-900/95 backdrop-blur-md rounded-full flex items-center justify-center hover:bg-primary-600 hover:text-white transition-all duration-300 shadow-xl hover:scale-110 hover:shadow-[0_0_20px_rgba(251,146,60,0.5)] active:scale-95 border border-gray-200 dark:border-dark-700"
        aria-label="Quick view"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
        </svg>
      </button>
      <span class="absolute right-full mr-2 top-1/2 -translate-y-1/2 px-2 py-1 bg-dark-900 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover/tooltip:opacity-100 transition-opacity pointer-events-none">Quick View</span>
    </div>
    
    <div class="relative group/tooltip">
      <button
        data-wishlist-toggle={id}
        class="w-11 h-11 bg-white/95 dark:bg-dark-900/95 backdrop-blur-md rounded-full flex items-center justify-center hover:bg-red-500 hover:text-white transition-all duration-300 shadow-xl hover:scale-110 hover:shadow-[0_0_20px_rgba(239,68,68,0.5)] active:scale-95 border border-gray-200 dark:border-dark-700"
        aria-label="Add to wishlist"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
        </svg>
      </button>
      <span class="absolute right-full mr-2 top-1/2 -translate-y-1/2 px-2 py-1 bg-dark-900 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover/tooltip:opacity-100 transition-opacity pointer-events-none">Wishlist</span>
    </div>
    
    <div class="relative group/tooltip">
      <button
        data-compare-toggle={id}
        class="w-11 h-11 bg-white/95 dark:bg-dark-900/95 backdrop-blur-md rounded-full flex items-center justify-center hover:bg-blue-500 hover:text-white transition-all duration-300 shadow-xl hover:scale-110 hover:shadow-[0_0_20px_rgba(59,130,246,0.5)] active:scale-95 border border-gray-200 dark:border-dark-700"
        aria-label="Add to compare"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
      </button>
      <span class="absolute right-full mr-2 top-1/2 -translate-y-1/2 px-2 py-1 bg-dark-900 text-white text-xs rounded whitespace-nowrap opacity-0 group-hover/tooltip:opacity-100 transition-opacity pointer-events-none">Compare</span>
    </div>
  </div>

  <!-- Image with Enhanced Zoom (110%) and Gradient Overlay -->
  <a href={`/product/${id}`} class="block relative overflow-hidden bg-gray-100 dark:bg-dark-700 aspect-square cursor-zoom-in">
    <img
      src={image}
      alt={name}
      class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700 ease-out"
      loading="lazy"
    />
    <!-- Enhanced Gradient Overlay -->
    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
  </a>

  <!-- Content - Mobile Optimized -->
  <div class="p-4 sm:p-5">
    <!-- Rating & Reviews - Mobile Optimized -->
    <div class="flex items-center justify-between mb-2">
      <div class="flex items-center gap-0.5 sm:gap-1">
        {Array.from({ length: 5 }).map((_, i) => (
          <svg
            class={`w-3 h-3 sm:w-4 sm:h-4 ${i < Math.floor(rating) ? 'text-yellow-400' : 'text-gray-300 dark:text-dark-600'}`}
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
          </svg>
        ))}
      </div>
      <span class="text-[10px] sm:text-xs text-gray-500 dark:text-gray-400 font-medium">({reviews})</span>
    </div>

    <!-- Name - Mobile Optimized -->
    <a href={`/product/${id}`} class="block">
      <h3 class="font-semibold text-sm sm:text-base text-gray-900 dark:text-white mb-2 sm:mb-3 line-clamp-2 leading-snug group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors min-h-[2.5rem]">
        {name}
      </h3>
    </a>

    <!-- Price - Mobile Optimized -->
    <div class="flex items-baseline gap-2 mb-2 sm:mb-3">
      <span class="text-xl sm:text-2xl font-bold text-primary-600 dark:text-primary-400">
        ${price.toFixed(2)}
      </span>
      {originalPrice && (
        <span class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 line-through">
          ${originalPrice.toFixed(2)}
        </span>
      )}
    </div>

    <!-- Stock & Delivery Info - Mobile Optimized -->
    <div class="space-y-1.5 sm:space-y-2 mb-3 sm:mb-4">
      {inStock ? (
        <>
          <div class="flex items-center gap-1 sm:gap-1.5 text-[10px] sm:text-xs text-green-600 dark:text-green-400 font-medium">
            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
            <span>In Stock - Ready to Ship</span>
          </div>
          <div class="flex items-center gap-1 sm:gap-1.5 text-[10px] sm:text-xs text-gray-600 dark:text-gray-400">
            <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>{estimatedDelivery}</span>
          </div>
        </>
      ) : (
        <span class="text-[10px] sm:text-xs text-red-600 dark:text-red-400 font-medium">Currently Unavailable</span>
      )}
    </div>

    <!-- Multi-Layer Add to Cart Button with Enhanced Animation - Mobile Optimized -->
    <button
      data-add-to-cart={id}
      data-product-name={name}
      data-product-price={price}
      data-product-image={image}
      disabled={!inStock}
      class="group/btn relative w-full py-3 sm:py-4 bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 disabled:from-gray-300 disabled:to-gray-400 dark:disabled:from-dark-700 dark:disabled:to-dark-700 disabled:text-gray-500 dark:disabled:text-gray-500 text-white rounded-xl font-bold text-xs sm:text-sm transition-all duration-300 hover:shadow-[0_0_30px_rgba(251,146,60,0.5)] disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-95 flex items-center justify-center gap-2 sm:gap-2.5 overflow-hidden"
    >
      {inStock ? (
        <>
          <!-- Layer 1: Base Gradient (already in class) -->
          
          <!-- Layer 2: Slide Effect Background -->
          <span class="absolute inset-0 bg-gradient-to-r from-primary-700 to-primary-800 translate-y-full group-hover/btn:translate-y-0 transition-transform duration-300 ease-out"></span>
          
          <!-- Layer 3: Shine Effect -->
          <span class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent -translate-x-full group-hover/btn:translate-x-full transition-transform duration-700 ease-out"></span>
          
          <!-- Layer 4: Icon with Scale Animation -->
          <svg class="w-4 h-4 sm:w-5 sm:h-5 relative z-10 group-hover/btn:scale-110 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          
          <!-- Text -->
          <span class="relative z-10 tracking-wide">Add to Cart</span>
          
          <!-- Success Checkmark (hidden by default, shown via JS) -->
          <svg class="w-4 h-4 sm:w-5 sm:h-5 relative z-10 hidden success-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
          </svg>
        </>
      ) : (
        <span class="flex items-center gap-1.5 sm:gap-2">
          <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          Out of Stock
        </span>
      )}
    </button>
  </div>
</div>

<script>
  // Add to cart functionality with success feedback
  document.querySelectorAll('[data-add-to-cart]').forEach(button => {
    button.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement;
      const id = target.dataset.addToCart!;
      const name = target.dataset.productName!;
      const price = parseFloat(target.dataset.productPrice!);
      const image = target.dataset.productImage!;

      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const existingItem = cart.find((item: any) => item.id === id);

      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({ id, name, price, image, quantity: 1 });
      }

      localStorage.setItem('cart', JSON.stringify(cart));
      
      // Update cart count
      const count = cart.reduce((sum: number, item: any) => sum + item.quantity, 0);
      document.querySelectorAll('[data-cart-count]').forEach(el => {
        el.textContent = count.toString();
      });

      // Enhanced visual feedback with success animation
      const cartIcon = target.querySelector('svg:not(.success-icon)');
      const successIcon = target.querySelector('.success-icon');
      const textSpan = target.querySelector('span:last-of-type');
      
      if (cartIcon && successIcon && textSpan) {
        // Hide cart icon, show success icon
        cartIcon.classList.add('hidden');
        successIcon.classList.remove('hidden');
        successIcon.classList.add('animate-bounce');
        textSpan.textContent = 'Added!';
        
        // Add success background
        target.classList.add('!bg-green-600', '!from-green-600', '!to-green-700');
        
        // Reset after 2 seconds
        setTimeout(() => {
          cartIcon.classList.remove('hidden');
          successIcon.classList.add('hidden');
          successIcon.classList.remove('animate-bounce');
          textSpan.textContent = 'Add to Cart';
          target.classList.remove('!bg-green-600', '!from-green-600', '!to-green-700');
        }, 2000);
      }
    });
  });

  // Quick View
  document.querySelectorAll('[data-quick-view]').forEach(button => {
    button.addEventListener('click', (e) => {
      e.preventDefault();
      const id = (e.currentTarget as HTMLElement).dataset.quickView!;
      // In production, this would open a modal with product details
      window.location.href = `/product/${id}`;
    });
  });

  // Wishlist toggle with enhanced feedback
  document.querySelectorAll('[data-wishlist-toggle]').forEach(button => {
    button.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement;
      const id = target.dataset.wishlistToggle!;
      
      const wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
      const index = wishlist.indexOf(id);
      
      if (index > -1) {
        wishlist.splice(index, 1);
        target.classList.remove('!bg-red-500', '!text-white', '!border-red-500');
        
        // Remove animation
        target.classList.remove('animate-pulse');
      } else {
        wishlist.push(id);
        target.classList.add('!bg-red-500', '!text-white', '!border-red-500');
        
        // Add pulse animation
        target.classList.add('animate-pulse');
        setTimeout(() => target.classList.remove('animate-pulse'), 1000);
      }
      
      localStorage.setItem('wishlist', JSON.stringify(wishlist));
      
      // Update wishlist count
      document.querySelectorAll('[data-wishlist-count]').forEach(el => {
        el.textContent = wishlist.length.toString();
      });
    });
  });

  // Compare toggle with max 4 products alert
  document.querySelectorAll('[data-compare-toggle]').forEach(button => {
    button.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement;
      const id = target.dataset.compareToggle!;
      
      const compare = JSON.parse(localStorage.getItem('compare') || '[]');
      const index = compare.indexOf(id);
      
      if (index > -1) {
        compare.splice(index, 1);
        target.classList.remove('!bg-blue-500', '!text-white', '!border-blue-500');
        
        // Remove animation
        target.classList.remove('animate-pulse');
      } else {
        if (compare.length >= 4) {
          // Show alert with better styling
          const alertDiv = document.createElement('div');
          alertDiv.className = 'fixed top-4 right-4 z-50 bg-red-600 text-white px-6 py-4 rounded-xl shadow-2xl animate-slide-in-right';
          alertDiv.innerHTML = `
            <div class="flex items-center gap-3">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <div>
                <p class="font-bold">Maximum Reached</p>
                <p class="text-sm">You can compare up to 4 products</p>
              </div>
            </div>
          `;
          document.body.appendChild(alertDiv);
          setTimeout(() => alertDiv.remove(), 3000);
          return;
        }
        compare.push(id);
        target.classList.add('!bg-blue-500', '!text-white', '!border-blue-500');
        
        // Add pulse animation
        target.classList.add('animate-pulse');
        setTimeout(() => target.classList.remove('animate-pulse'), 1000);
      }
      
      localStorage.setItem('compare', JSON.stringify(compare));
    });
  });

  // Initialize wishlist and compare states on page load
  document.addEventListener('DOMContentLoaded', () => {
    const wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
    const compare = JSON.parse(localStorage.getItem('compare') || '[]');
    
    wishlist.forEach((id: string) => {
      const button = document.querySelector(`[data-wishlist-toggle="${id}"]`);
      if (button) {
        button.classList.add('!bg-red-500', '!text-white', '!border-red-500');
      }
    });
    
    compare.forEach((id: string) => {
      const button = document.querySelector(`[data-compare-toggle="${id}"]`);
      if (button) {
        button.classList.add('!bg-blue-500', '!text-white', '!border-blue-500');
      }
    });
  });
</script>
